# CAN 트랜시버 (TJA1043) 데이터시트 분석

## 데이터시트 분석의 목적

### 필수성
- CAN 통신 사용 시 **트랜시버는 필수 구성요소**
- 사용하는 트랜시버 제품의 특성 파악 필요
- 하드웨어 설계 및 소프트웨어 개발에 필요한 정보 확보

### TJA1043 선택 이유
- **NXP Semiconductors** 제조의 대표적인 CAN 트랜시버
- 산업계에서 널리 사용되는 제품
- 다양한 기능을 포함한 고성능 트랜시버

<br>

## 데이터시트 기본 구조

### General Description (일반 설명)
- **인터페이스 역할**: CAN 컨트롤러와 CAN 버스 간 인터페이스 제공
- **고속 CAN 지원**: High-speed CAN 통신용으로 설계
- **추가 기능**: 전원 제어 및 웨이크업 기능
- **보호 기능**: 단락, 과전압 등에 대한 보호 및 진단

### Features (주요 특징)
- **통신 모드**: Normal, Listen-Only, Standby, Sleep 모드 지원
- **전력 관리**: 저전력 모드 및 웨이크업 기능
- **보호 기능**: 과온도, 단락 보호
- **진단 기능**: 다양한 오류 상황 감지 및 보고

<br>

## 핀 구성 및 기능

### 통신 관련 핀

#### CAN_H / CAN_L
- **기능**: CAN 버스 연결용 차동 신호 핀
- **연결**: 실제 CAN 네트워크 버스에 직접 연결
- **신호**: Dominant/Recessive 차동 신호 출력

#### TXD (Transmit Data)
- **방향**: Input (MCU → Transceiver)
- **기능**: MCU로부터 송신 데이터 수신
- **연결**: MCU의 CAN TX 핀과 연결

#### RXD (Receive Data)
- **방향**: Output (Transceiver → MCU)
- **기능**: 수신된 데이터를 MCU에 전달
- **연결**: MCU의 CAN RX 핀과 연결

### 제어 관련 핀

#### STB (Standby)
- **기능**: 동작 모드 제어
- **방향**: Input (MCU에서 제어)
- **역할**: 다른 제어 핀과 조합하여 동작 모드 결정

#### EN (Enable)
- **기능**: 활성화 제어
- **방향**: Input (MCU에서 제어)
- **역할**: STB 핀과 함께 동작 모드 선택

#### ERR (Error)
- **기능**: 오류 상태 알림
- **방향**: Output (Transceiver → MCU)
- **특성**: Active-Low (오류 시 Low, 정상 시 High)

### 전원 관련 핀

#### VBAT (Battery Voltage)
- **기능**: 트랜시버 전원 공급
- **연결**: 차량 배터리에 직접 연결
- **전압**: 일반적으로 12V 차량 배터리

#### INH (Inhibit)
- **기능**: 외부 장치 전원 제어
- **역할**: MCU 전원 스위치 제어에 사용
- **상태**: 동작 모드에 따라 Active/Floating

#### WAKE
- **기능**: 로컬 웨이크업 신호 입력
- **트리거**: 전압 레벨 변화 감지
- **용도**: 외부 신호에 의한 웨이크업

<br>

## 동작 모드 상세 분석

### Normal Mode (정상 모드)

#### 기본 기능
- **송수신**: CAN 메시지 송신 및 수신 모두 가능
- **표준 동작**: 일반적인 CAN 통신에 사용
- **INH 핀**: Active 상태 유지

#### 진입 조건
- **STB 핀**: High
- **EN 핀**: High
- **사용법**: MCU가 두 제어 핀을 모두 High로 설정

### Listen-Only Mode (수신 전용 모드)

#### 기본 기능
- **수신만**: 메시지 수신만 가능, 송신 불가
- **모니터링**: 버스 트래픽 관찰용
- **버스 영향 없음**: 버스 상태에 영향을 주지 않음

#### 진입 조건
- **STB 핀**: High
- **EN 핀**: Low

#### 활용 예시
- **디버깅**: CAN 네트워크 트래픽 분석
- **테스트**: 버스에 영향 없이 통신 상태 확인
- **진단**: 네트워크 문제 분석

### Standby Mode (대기 모드)

#### 기본 기능
- **전력 절약**: 최소 전류 소모 모드
- **통신 중단**: 송수신 모두 불가능
- **INH 핀**: 여전히 Active 상태

#### 진입 조건
- **STB 핀**: Low
- **EN 핀**: Low

#### 특징
- Power Save 모드의 한 형태
- 트랜시버 내부 전원 스위치 OFF
- MCU는 여전히 동작 상태 유지 가능

### Go-To-Sleep Mode (슬립 진입 모드)

#### 기본 기능
- **중간 단계**: Sleep 모드 진입을 위한 과도기 상태
- **타이머**: 일정 시간 후 자동으로 Sleep 모드 전환
- **준비 단계**: Sleep 진입 전 필요한 처리 수행

#### 진입 조건
- **STB 핀**: Low
- **EN 핀**: High

### Sleep Mode (슬립 모드)

#### 기본 기능
- **최대 절전**: 가장 낮은 전력 소모
- **통신 중단**: 송수신 완전 차단
- **INH 핀**: Floating 상태 (MCU 전원 차단 가능)

#### 진입 과정
1. Go-To-Sleep 모드 진입
2. 일정 시간 대기
3. 자동으로 Sleep 모드 전환

#### 웨이크업 조건
- **Local Wakeup**: WAKE 핀 신호 변화
- **Remote Wakeup**: CAN 버스의 특정 패턴 감지
- **Control Pins**: STB/EN 핀 조작

<br>

## 웨이크업 메커니즘

### Wake Flag
- **설정 조건**: Local 또는 Remote 웨이크업 요청 시
- **역할**: Sleep 모드 탈출 조건
- **상태**: 웨이크업 요청 발생 시 자동 설정

### Local Wakeup (로컬 웨이크업)

#### 동작 원리
- **WAKE 핀 모니터링**: 전압 레벨 변화 감지
- **트리거 조건**: High↔Low 전환 후 일정 시간 유지
- **예시**: 
  - High → Low로 변화 후 유지
  - Low → High로 변화 후 유지

#### 활용 사례
- **사용자 입력**: 스위치나 버튼 신호
- **센서 신호**: 특정 조건 감지 시
- **외부 장치**: 다른 시스템으로부터의 신호

### Remote Wakeup (원격 웨이크업)

#### 동작 원리
- **패턴 감지**: CAN 버스의 특정 신호 패턴 인식
- **웨이크업 패턴**: Dominant → Recessive → Dominant 순서
- **타이밍**: 각 상태의 지속 시간이 규격에 맞아야 함

#### 패턴 상세
```
Dominant (0) → 일정 시간 지속
Recessive (1) → 일정 시간 지속  
Dominant (0) → 일정 시간 지속
```

#### 활용 시나리오
1. **MCU 전원 차단**: 전력 절약을 위해 MCU OFF
2. **트랜시버 대기**: Sleep 모드에서 신호 대기
3. **웨이크업 신호**: 다른 ECU가 웨이크업 패턴 전송
4. **시스템 복귀**: 트랜시버가 MCU 전원 재공급

<br>

## INH 핀과 전원 제어

### INH 핀의 역할

#### 기본 개념
- **전원 스위치 제어**: 외부 장치의 전원 공급 제어
- **MCU 전원 관리**: 주로 MCU 전원 ON/OFF 제어
- **모드별 상태**:
  - Normal/Standby: Active (High)
  - Sleep: Floating (Low)

### 전원 제어 회로 구성

#### 기본 구조
```
배터리 → 전원 스위치 → MCU 전원 핀
           ↑
      INH 핀 (제어 신호)
```

#### 동작 시퀀스
1. **정상 동작**: INH High → 스위치 ON → MCU 전원 공급
2. **슬립 진입**: INH Floating → 스위치 OFF → MCU 전원 차단
3. **웨이크업**: INH High → 스위치 ON → MCU 전원 재공급

### 실제 구현 고려사항

#### 회로 설계
- **전원 스위치**: P-channel MOSFET 또는 전용 IC 사용
- **풀업 저항**: INH 핀에 적절한 풀업 저항 연결
- **디커플링**: 안정적인 전원 공급을 위한 캐패시터

#### 소프트웨어 제어
- **모드 전환**: 적절한 타이밍에 모드 변경
- **상태 확인**: 웨이크업 후 시스템 상태 검증
- **에러 처리**: 전원 제어 실패 시 대응 방안

<br>

## 오류 감지 및 진단

### Error 핀 기능

#### 기본 특성
- **신호 형태**: Active-Low (정상 시 High, 오류 시 Low)
- **알림 기능**: 트랜시버 내부 오류 상태를 MCU에 통지
- **실시간 모니터링**: 지속적인 상태 감시

#### 감지 가능한 오류
- **과온도**: 트랜시버 온도가 안전 범위 초과
- **단락**: CAN_H 또는 CAN_L의 단락 상황
- **전원 이상**: 공급 전압의 이상 상태
- **통신 오류**: CAN 프로토콜 레벨 오류

### 진단 기능 활용

#### MCU에서의 처리
1. **Error 핀 모니터링**: 주기적 또는 인터럽트 방식
2. **상태 판별**: Low 신호 감지 시 오류 상황 인식
3. **대응 조치**: 오류 종류에 따른 적절한 처리
4. **로깅**: 오류 발생 이력 기록

#### 시스템 보호
- **즉시 대응**: 심각한 오류 시 즉시 보호 동작
- **격리**: 문제 있는 구간의 격리
- **복구**: 가능한 경우 자동 복구 시도

<br>

## 데이터시트 활용 가이드

### 설계 단계에서의 활용

#### 하드웨어 설계
- **핀 연결**: 각 핀의 기능에 맞는 적절한 연결
- **모드 제어**: 필요한 동작 모드에 따른 제어 핀 설계
- **보호 회로**: 권장되는 보호 회로 구성

#### 소프트웨어 설계
- **초기화**: 트랜시버 시작 시 필요한 설정
- **모드 관리**: 상황에 따른 적절한 모드 전환
- **오류 처리**: 각종 오류 상황에 대한 대응

### 개발 단계에서의 활용

#### 기능 구현
- **모드 전환 코드**: 각 모드로의 전환 함수 구현
- **상태 모니터링**: 트랜시버 상태 실시간 확인
- **웨이크업 처리**: 웨이크업 조건 설정 및 처리

#### 테스트 및 검증
- **동작 확인**: 각 모드에서의 정상 동작 확인
- **오류 시뮬레이션**: 의도적 오류 발생으로 보호 기능 검증
- **전력 측정**: 각 모드에서의 실제 소비 전류 측정

<br>

## 실무 적용 시 주의사항

### 제품별 차이점
- **트랜시버 제조사**: 각 회사별 특성 및 기능 차이
- **버전 차이**: 동일 제품도 버전에 따른 기능 변화
- **핀 배치**: 패키지 형태에 따른 핀 번호 확인

### 회로 설계 고려사항
- **모드 제어 방식**: 항상 Normal 모드 vs 동적 모드 전환
- **전원 관리**: INH 핀 활용 여부 결정
- **보호 기능**: 필요한 보호 기능 선택

### 소프트웨어 구현 팁
- **초기화 순서**: 올바른 트랜시버 초기화 시퀀스
- **타이밍**: 모드 전환 시 필요한 대기 시간
- **예외 처리**: 예상치 못한 상황에 대한 대비

<br>

## 핵심 요약

1. **데이터시트 필수성**: CAN 트랜시버 사용 시 해당 제품 데이터시트 숙지 필수
2. **핀 기능 파악**: 각 핀의 역할과 연결 방법 정확한 이해
3. **동작 모드**: Normal, Listen-Only, Standby, Sleep 모드의 특성과 용도
4. **웨이크업 기능**: Local/Remote 웨이크업을 통한 전력 관리
5. **INH 핀 활용**: MCU 전원 제어를 통한 시스템 레벨 전력 관리
6. **오류 감지**: Error 핀을 통한 실시간 상태 모니터링
7. **실무 적용**: 제품 특성에 맞는 적절한 기능 선택 및 구현