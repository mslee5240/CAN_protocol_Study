# CAN 통신 속도 (BaudRate)

## BaudRate 기본 개념

### 정의
- **BaudRate**: CAN 통신에서 사용하는 통신 속도
- **단위**: BPS (Bit Per Second)
- **의미**: 1초 동안 전송할 수 있는 비트 수

### 중요성
- **처리량**: BPS 값이 클수록 동일 시간에 더 많은 데이터 전송 가능
- **실시간성**: 빠른 통신으로 시스템 응답성 향상
- **효율성**: 네트워크 대역폭 활용도 최적화

<br>

## 통일된 속도 사용의 필요성

### 필수 조건
- **동일 버스 내 모든 제어기**: 반드시 동일한 BaudRate 사용
- **혼용 불가**: 서로 다른 속도 사용 시 통신 오류 발생
- **네트워크 동기화**: 모든 노드가 동일한 타이밍으로 동작

### 오류 발생 원인
- **비트 타이밍 불일치**: 송신과 수신 타이밍 차이
- **프레임 동기화 실패**: 메시지 경계 인식 불가
- **ACK 응답 타이밍 문제**: 확인 신호 전송/수신 실패

<br>

## 사양 결정 주체 및 프로세스

### OEM의 역할 (완성차 업체)
- **네트워크 설계**: 차량 내 CAN 네트워크 토폴로지 결정
- **사양 정의**: BaudRate, 샘플링 포인트 등 통신 파라미터 설정
- **CAN-DB 제공**: 통신 사양을 담은 데이터베이스 파일 배포

### 공급업체의 역할 (부품사)
- **사양 준수**: OEM에서 제공한 통신 사양에 따른 개발
- **소프트웨어 구현**: 지정된 BaudRate로 동작하는 프로그램 개발
- **테스트 및 검증**: 사양 적합성 확인

### CAN-DB (CAN Database)
- **내용**: BaudRate, 메시지 정의, 신호 매핑 등
- **형식**: .dbc, .sym 등의 파일 형태
- **활용**: 개발, 테스트, 진단 도구에서 공통 사용

<br>

## CAN 통신의 종류

### Low-Speed CAN
- **속도 범위**: 최대 125 kbps
- **특징**: 단일선 사용 가능, 내결함성 우수
- **용도**: 편의 기능 (도어, 창문, 조명 등)

### High-Speed CAN (Classical CAN)
- **속도 범위**: 최대 1 Mbps
- **특징**: 차동 신호, 높은 노이즈 내성
- **일반적 사용**: 500 kbps (가장 널리 사용되는 속도)
- **용도**: 엔진, 변속기, 브레이크 등 핵심 제어

### CAN FD (CAN with Flexible Data-rate)
- **속도 범위**: 데이터 필드에서 최대 8 Mbps 이상
- **특징**: 가변 데이터 속도, 확장된 페이로드
- **장점**: 높은 처리량, 효율적인 대역폭 사용
- **용도**: ADAS, 인포테인먼트 등 대용량 데이터 처리

<br>

## 통신 속도와 케이블 길이의 관계

### 물리적 제약 요인

#### 신호 전파 지연
- **전파 속도**: 약 2/3 × 빛의 속도 (일반적인 케이블)
- **왕복 지연**: 신호가 케이블 끝까지 가서 돌아오는 시간
- **비트 타임**: 한 비트의 전송 시간

#### ACK 메커니즘과의 관계
- **ACK 대기**: 송신자는 1비트 시간 동안 ACK 신호 대기
- **물리적 지연**: 케이블이 길수록 ACK 도달 시간 증가
- **타이밍 충돌**: 대기 시간 < 전파 지연 시 통신 실패

### 속도별 최대 케이블 길이

| 통신 속도 | 최대 케이블 길이 | 용도 |
|-----------|------------------|------|
| 1 Mbps | 40m | 고속 제어 시스템 |
| 500 kbps | 130m | 일반적인 차량 네트워크 |
| 250 kbps | 250m | 대형 차량 |
| 125 kbps | 500m | 산업용 장비 |
| 62.5 kbps | 1000m | 장거리 통신 |
| 20 kbps | 2500m | 극장거리 응용 |

### 실제 적용 고려사항
- **케이블 품질**: 특성 임피던스, 노이즈 차폐 성능
- **연결점**: 커넥터, 분기점 등에서의 신호 반사
- **환경 요인**: 온도, 습도, 전자기 간섭

<br>

## 샘플링 포인트 (Sampling Point)

### 기본 개념
- **정의**: 비트 값(0 또는 1)을 판단하는 특정 시점
- **단위**: 퍼센트 (%)
- **위치**: 1비트 시간 내에서의 상대적 위치

### 샘플링 시점의 중요성
- **정확한 판단**: 신호가 안정된 상태에서 값 읽기
- **노이즈 회피**: 신호 천이 구간을 피한 안정 구간에서 샘플링
- **타이밍 여유**: 송신기와 수신기 간의 클럭 차이 보정

### 일반적인 설정값
- **권장 범위**: 75% ~ 87.5%
- **High-Speed CAN**: 보통 87.5%
- **Low-Speed CAN**: 보통 75%

<br>

## Time Quantum과 비트 타이밍

### Time Quantum (Tq)
- **정의**: CAN 컨트롤러의 기본 시간 단위
- **계산**: Tq = 1 / (CAN 클럭 주파수)
- **역할**: 비트 타이밍 파라미터의 기준 단위

### 비트 구조 (Bit Segments)

#### 1. Synchronization Segment (Sync_Seg)
- **길이**: 항상 1 Tq (고정값)
- **역할**: 비트 시작점 동기화
- **기능**: 하드 동기화 수행

#### 2. Propagation Delay Segment (Prop_Seg)
- **길이**: 1~8 Tq (설정 가능)
- **역할**: 신호 전파 지연 시간 보상
- **계산**: 케이블 길이 × 2 × 전파 지연 시간

#### 3. Phase Segment 1 (Phase_Seg1)
- **길이**: 1~8 Tq (설정 가능)
- **역할**: 샘플링 포인트 조정
- **기능**: 클럭 편차 보상을 위한 연장 가능

#### 4. Phase Segment 2 (Phase_Seg2)
- **길이**: 1~8 Tq (설정 가능)
- **역할**: 송신 포인트까지의 시간 확보
- **제약**: max(Phase_Seg1, IPT) ≥ Phase_Seg2

### 타이밍 파라미터

#### TSEG1 (Time Segment 1)
- **구성**: Prop_Seg + Phase_Seg1
- **역할**: 샘플링 포인트 이전 구간
- **범위**: 1~16 Tq

#### TSEG2 (Time Segment 2)
- **구성**: Phase_Seg2
- **역할**: 샘플링 포인트 이후 구간
- **범위**: 1~8 Tq

#### SJW (Synchronization Jump Width)
- **정의**: 재동기화 시 조정 가능한 최대 시간
- **범위**: 1~4 Tq
- **제약**: SJW ≤ min(Phase_Seg1, Phase_Seg2)
- **역할**: 클럭 편차 보정

### 샘플링 포인트 계산
```
샘플링 포인트(%) = (Sync_Seg + TSEG1) / (Sync_Seg + TSEG1 + TSEG2) × 100
                  = (1 + TSEG1) / (1 + TSEG1 + TSEG2) × 100
```

### BaudRate 계산
```
BaudRate = CAN 클럭 주파수 / (1 + TSEG1 + TSEG2)
         = CAN 클럭 주파수 / 총 Tq 수
```

<br>

## 실제 설정 예시

### 예시 1: 500 kbps, 87.5% 샘플링 포인트
- **CAN 클럭**: 8 MHz
- **총 Tq**: 16 (8MHz / 500kHz = 16)
- **설정**:
  - Sync_Seg = 1 Tq (고정)
  - TSEG1 = 13 Tq
  - TSEG2 = 2 Tq
  - SJW = 1 Tq
- **샘플링 포인트**: (1 + 13) / 16 × 100 = 87.5%

### 예시 2: 250 kbps, 75% 샘플링 포인트
- **CAN 클럭**: 8 MHz
- **총 Tq**: 32 (8MHz / 250kHz = 32)
- **설정**:
  - Sync_Seg = 1 Tq (고정)
  - TSEG1 = 23 Tq
  - TSEG2 = 8 Tq
  - SJW = 4 Tq
- **샘플링 포인트**: (1 + 23) / 32 × 100 = 75%

<br>

## 소프트웨어 구현 고려사항

### MCU CAN 컨트롤러 설정
1. **클럭 소스 설정**: CAN 컨트롤러에 공급할 클럭 선택
2. **분주비 설정**: 원하는 CAN 클럭 주파수 생성
3. **비트 타이밍 레지스터**: TSEG1, TSEG2, SJW 값 설정
4. **검증**: 실제 BaudRate와 샘플링 포인트 확인

### 개발 도구 활용
- **CANoe/CANalyzer**: Vector사 CAN 분석 도구
- **설정 필요 항목**:
  - BaudRate
  - 샘플링 포인트
  - SJW (선택사항)

### 테스트 및 검증
- **오실로스코프**: 실제 비트 타이밍 측정
- **CAN 분석기**: 통신 품질 및 오류율 확인
- **상호 운용성**: 다른 제조사 제품과의 호환성 테스트

<br>

## 문제 해결 가이드

### 일반적인 문제

#### BaudRate 불일치
- **증상**: 통신 완전 불가, 지속적인 오류
- **해결**: 모든 노드의 BaudRate 통일

#### 샘플링 포인트 부적절
- **증상**: 간헐적 통신 오류, 노이즈에 민감
- **해결**: 권장 범위 내 샘플링 포인트 재설정

#### 케이블 길이 초과
- **증상**: 고속에서 통신 불안정
- **해결**: 케이블 길이 단축 또는 속도 감소

### 디버깅 절차
1. **BaudRate 확인**: 설정값과 실제값 비교
2. **신호 품질 측정**: 오실로스코프로 파형 확인
3. **오류 통계**: CAN 컨트롤러 오류 카운터 모니터링
4. **환경 점검**: 노이즈 소스, 그라운드 상태 확인

<br>

## 핵심 요약

1. **BaudRate**: 1초당 전송 가능한 비트 수 (단위: BPS)
2. **통일 필수**: 동일 버스 내 모든 노드가 동일한 속도 사용
3. **OEM 결정**: 완성차 업체에서 통신 사양 결정 후 CAN-DB로 배포
4. **속도 제약**: 높은 속도일수록 케이블 길이 제한
5. **샘플링 포인트**: 비트 값 판단 시점 (일반적으로 75-87.5%)
6. **Time Quantum**: CAN 비트 타이밍의 기본 단위
7. **파라미터 설정**: TSEG1, TSEG2, SJW를 통한 정밀한 타이밍 제어