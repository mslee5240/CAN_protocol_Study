# CAN 트랜시버 & CAN 컨트롤러

## 제어기(ECU) 구조 개요

### 제어기의 정의
- **전자 제어 장치(ECU)**: Electronic Control Unit
- **역할**: 자동차 내 각종 전자장치를 제어하는 컴퓨터
- **예시**: 브레이크 제어기, 에어백 제어기, 엔진 제어기 등

### 물리적 구조
- **회로 기판**: PCB(Printed Circuit Board) 형태
- **패키징**: 보호 케이스로 포장하여 차량 내 설치
- **연결**: 커넥터를 통한 외부 장치 연결

<br>

## MCU (Microcontroller Unit)

### 기본 개념
- **정의**: 마이크로컨트롤러 유닛
- **역할**: 제어기 내부의 핵심 컴퓨팅 장치
- **형태**: 검은색 네모난 칩 형태

### 내부 구성요소
- **CPU**: 중앙처리장치
- **메모리**: RAM, Flash, EEPROM 등
- **페리퍼럴**: 다양한 하드웨어 기능 모듈

### 페리퍼럴 (Peripherals)
MCU 내부에 내장된 하드웨어 기능 블록들:
- **CAN 컨트롤러**: CAN 통신 처리
- **UART**: 시리얼 통신
- **SPI/I2C**: 동기식 통신
- **ADC**: 아날로그-디지털 변환
- **PWM**: 펄스 폭 변조
- **타이머**: 시간 측정 및 제어

<br>

## CAN 컨트롤러

### 기본 역할
CAN 통신 프로토콜에 따른 직접적인 통신 작업을 수행하는 MCU 내부 페리퍼럴

### 주요 기능

#### 메시지 구성 및 전송
- **프레임 생성**: CAN 메시지의 다양한 필드 구성
- **데이터 패키징**: 송신할 데이터를 CAN 프레임 형태로 변환
- **전송 관리**: 완성된 메시지를 MCU 외부로 출력

#### 버스 상태 모니터링
- **버스 감시**: 다른 제어기의 메시지 전송 여부 확인
- **송신 타이밍**: 버스가 비어있을 때만 메시지 전송
- **충돌 감지**: 동시 전송 시 중재(Arbitration) 수행

#### 프로토콜 처리
- **메시지 수신**: 버스로부터 들어오는 메시지 해석
- **에러 처리**: CAN 프로토콜 에러 감지 및 처리
- **필터링**: 필요한 메시지만 선별적으로 수신

#### 인터럽트 및 상태 관리
- **송수신 완료 알림**: CPU에 인터럽트 신호 전송
- **에러 상태 보고**: 통신 오류 상황 CPU에 통지
- **버퍼 관리**: 송수신 메시지 임시 저장

<br>

## CAN 트랜시버 (Transceiver)

### 용어 정의
- **Transceiver**: Transmitter + Receiver의 합성어
- **송수신기**: 신호를 송신하고 수신하는 장치

### 필요성

#### MCU와 CAN 버스 간 전압 레벨 차이
**MCU 디지털 신호**:
- 논리 1: 3.3V 또는 5V
- 논리 0: 0V

**CAN 버스 신호**:
- Dominant (0): CAN_H = 3.75V, CAN_L = 1.25V
- Recessive (1): CAN_H = 2.5V, CAN_L = 2.5V

#### 변환 기능의 필요성
- MCU는 CAN 버스의 차동 신호를 직접 생성/해석 불가
- 전압 레벨 및 신호 형태의 변환이 필수
- 물리 계층과 논리 계층 간의 인터페이스 역할

### 트랜시버의 주요 기능

#### 송신 기능 (CAN TX)
1. **신호 변환**: 디지털 로직 레벨 → CAN 차동 신호
2. **드라이브 능력**: 버스 구동을 위한 충분한 전류 공급
3. **타이밍 제어**: 정확한 비트 타이밍 유지

#### 수신 기능 (CAN RX)
1. **신호 감지**: CAN 버스의 차동 신호 감지
2. **레벨 변환**: CAN 차동 신호 → 디지털 로직 레벨
3. **노이즈 필터링**: 신호 품질 향상을 위한 필터링

### CAN TX/RX 신호

#### CAN TX (Transmit)
- **방향**: CAN Controller → CAN Transceiver
- **역할**: 송신할 데이터(0 또는 1)를 트랜시버에 전달
- **신호 형태**: 디지털 로직 레벨 (3.3V/5V ↔ 0V)

#### CAN RX (Receive)
- **방향**: CAN Transceiver → CAN Controller
- **역할**: 수신된 데이터를 컨트롤러에 전달
- **신호 형태**: 디지털 로직 레벨로 변환된 신호

### 물리적 구성

#### 위치 및 연결
- **트랜시버 위치**: MCU 외부의 별도 IC
- **컨트롤러 위치**: MCU 내부 페리퍼럴
- **연결 방식**: MCU의 CAN TX/RX 핀을 통해 연결

#### 신호 흐름
```
송신: CPU → CAN Controller → CAN TX → Transceiver → CAN Bus
수신: CAN Bus → Transceiver → CAN RX → CAN Controller → CPU
```

<br>

## 트랜시버의 동작 모드

### 일반적인 동작 모드

#### Normal Mode (정상 모드)
- **기능**: 메시지 송신 및 수신 모두 가능
- **용도**: 일반적인 CAN 통신 상황
- **특징**: 완전한 양방향 통신

#### Listen-Only Mode (수신 전용 모드)
- **기능**: 메시지 수신만 가능, 송신 불가
- **용도**: 버스 모니터링, 디버깅
- **특징**: 버스에 영향을 주지 않음

#### Sleep Mode (절전 모드)
- **기능**: 통신 완전 중단
- **용도**: 전력 절약
- **특징**: 웨이크업 신호로 복귀 가능

#### Standby Mode (대기 모드)
- **기능**: 웨이크업 패턴 감지만 가능
- **용도**: 저전력 대기 상태
- **특징**: 특정 신호로 Normal Mode 전환

### 모드 제어 방법
- **제어 핀**: 트랜시버의 전용 제어 핀 사용
- **SPI/I2C**: 시리얼 통신을 통한 레지스터 설정
- **소프트웨어**: MCU에서 해당 핀 제어

<br>

## 대표적인 CAN 트랜시버

### TJA1043 (NXP)
- **제조사**: NXP Semiconductors
- **특징**: 고성능 CAN FD 지원
- **동작 모드**: Normal, Standby, Sleep
- **보호 기능**: 과전압, 과온도 보호

### MCP2551 (Microchip)
- **제조사**: Microchip Technology
- **특징**: 널리 사용되는 표준 트랜시버
- **속도**: 최대 1Mbps
- **전원**: 5V 단일 전원

### TJA1050 (NXP)
- **제조사**: NXP Semiconductors
- **특징**: 산업 표준 호환성
- **온도 범위**: -40°C ~ +125°C
- **패키지**: SO8, TSSOP8

<br>

## 설계 시 고려사항

### 트랜시버 선택 기준
- **통신 속도**: 필요한 비트레이트 지원
- **동작 온도**: 사용 환경의 온도 범위
- **전원 전압**: 시스템 전원과의 호환성
- **패키지 형태**: PCB 레이아웃에 적합한 패키지
- **추가 기능**: 절전 모드, 보호 기능 등

### 회로 설계 주의사항
- **그라운드 연결**: 적절한 그라운드 처리
- **전원 디커플링**: 안정적인 전원 공급
- **신호 무결성**: PCB 레이아웃 최적화
- **EMC 대응**: 전자기 적합성 고려

### 소프트웨어 고려사항
- **초기화 순서**: 트랜시버 모드 설정 → CAN 컨트롤러 활성화
- **에러 처리**: 트랜시버 상태 모니터링
- **전력 관리**: 적절한 모드 전환으로 전력 절약

<br>

## 핵심 요약

1. **MCU 구조**: 제어기 내부의 MCU에 다양한 페리퍼럴 내장
2. **CAN 컨트롤러**: MCU 내부 페리퍼럴로 CAN 프로토콜 처리
3. **CAN 트랜시버**: MCU 외부 IC로 물리 계층 신호 변환
4. **신호 인터페이스**: CAN TX/RX로 컨트롤러와 트랜시버 연결
5. **필수 구성요소**: CAN 통신을 위해 반드시 필요한 하드웨어
6. **동작 모드**: 다양한 모드로 전력 효율성 및 기능성 제공