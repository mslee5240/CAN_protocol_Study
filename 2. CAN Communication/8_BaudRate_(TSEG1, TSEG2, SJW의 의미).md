# CAN 동기화 메커니즘 (TSEG1, TSEG2, SJW)

## 동기화의 필요성

### 브로드캐스트 통신의 특성
- **동시 수신**: 모든 노드가 동일한 메시지를 동시에 수신
- **타이밍 일치**: 송신과 수신 타이밍이 정확히 맞아야 함
- **데이터 무결성**: 모든 노드가 동일한 비트 값(0 또는 1)으로 해석

### 동기화 실패 시 문제점
- **데이터 오해석**: 송신 데이터와 다른 값으로 수신
- **통신 오류**: 프레임 동기화 실패로 인한 오류 발생
- **시스템 불안정**: 제어 시스템의 오동작 가능성

<br>

## 클럭 오차와 누적 문제

### 클럭 오차의 원인

#### 크리스털 오실레이터 오차
- **제조 공차**: 각 크리스털마다 고유한 주파수 오차
- **온도 의존성**: 온도 변화에 따른 주파수 변동
- **노화**: 시간 경과에 따른 특성 변화
- **일반적 오차 범위**: ±50ppm ~ ±100ppm

#### 오차 누적 현상
실제 예시 (설명을 위한 극단적 케이스):
- **설계값**: 10Hz CAN 클럭
- **제어기 A**: 정확히 10Hz 동작
- **제어기 B**: 10% 오차로 11Hz 동작

### 누적 오차의 영향

#### 시간 인식 차이
- **제어기 A**: 1초 = 10 클럭
- **제어기 B**: 0.9초를 1초로 인식 (11Hz ÷ 10 = 1.1, 따라서 10/11 ≈ 0.9초)

#### BaudRate 1bps 가정 시 문제
```
시간 경과 | 제어기 A (10Hz) | 제어기 B (11Hz) | 비트 차이
---------|-----------------|-----------------|----------
1초      | 1 비트 처리     | 1.1 비트 인식   | 0.1 비트
10초     | 10 비트 처리    | 11 비트 인식    | 1 비트
100초    | 100 비트 처리   | 110 비트 인식   | 10 비트
```

### 동기화 필요 조건
- **주기적 동기화**: 오차 누적 방지를 위한 정기적 타이밍 보정
- **실시간 감지**: 다른 노드의 신호 변화 실시간 모니터링
- **자동 보정**: 감지된 타이밍 차이의 자동 보상

<br>

## 하드 동기화 vs 재동기화

### 하드 동기화 (Hard Synchronization)
- **발생 시점**: 프레임 시작 시 (SOF: Start of Frame)
- **기능**: 모든 노드의 비트 타이밍을 강제로 동기화
- **특징**: 완전한 타이밍 리셋

### 재동기화 (Resynchronization)
- **발생 시점**: 프레임 내부의 비트 경계에서
- **조건**: 예상 타이밍과 실제 에지 타이밍의 차이 감지
- **제한**: SJW 범위 내에서만 조정 가능

<br>

## Phase Segment의 역할

### Phase Segment 1 (Phase_Seg1)

#### 기본 기능
- **버퍼 역할**: 샘플링 포인트 이전의 여유 시간 제공
- **연장 가능**: 클럭이 빠른 노드의 타이밍 보정

#### 클럭이 빠른 경우의 보정

**상황 설정**:
- 제어기 A: 10Hz (정확)
- 제어기 B: 11Hz (빠름)

**동작 과정**:
1. **타이밍 차이 감지**: 제어기 B가 Phase_Seg1 구간에서 다른 노드의 신호 에지 감지
2. **빠름 인식**: 자신이 예상보다 빠르게 동작 중임을 인식
3. **Phase_Seg1 연장**: 다음 비트에서 Phase_Seg1을 SJW만큼 연장
4. **타이밍 동기화**: 연장을 통해 다른 노드와 타이밍 일치

**시간 계산 예시**:
```
제어기 A: 1.0초 | 1.0초 | 1.0초 (총 3.0초)
제어기 B: 0.9초 | 0.9초 | 1.2초 (0.9+0.3 연장, 총 3.0초)
```

### Phase Segment 2 (Phase_Seg2)

#### 기본 기능
- **송신 준비**: 다음 비트 송신을 위한 준비 시간
- **단축 가능**: 클럭이 느린 노드의 타이밍 보정

#### 클럭이 느린 경우의 보정

**상황 설정**:
- 제어기 A: 10Hz (정확)
- 제어기 B: 9Hz (느림)

**동작 과정**:
1. **타이밍 차이 감지**: 제어기 B가 Phase_Seg2 구간에서 다른 노드의 신호 에지 감지
2. **늦음 인식**: 자신이 예상보다 늦게 동작 중임을 인식
3. **Phase_Seg2 단축**: 현재 비트에서 Phase_Seg2를 SJW만큼 단축
4. **타이밍 동기화**: 단축을 통해 다른 노드와 타이밍 일치

**시간 계산 예시**:
```
제어기 A: 1.0초 | 1.0초 (총 2.0초)
제어기 B: 1.1초 | 0.9초 (1.1-0.2 단축, 총 2.0초)
```

<br>

## SJW (Synchronization Jump Width)

### 정의 및 역할
- **최대 조정량**: Phase Segment 연장/단축 시 조정 가능한 최대 Time Quantum 수
- **범위**: 1~4 Tq (일반적으로 1 Tq 사용)
- **제한 조건**: SJW ≤ min(Phase_Seg1, Phase_Seg2)

### 조정 규칙

#### Phase_Seg1 연장 (클럭이 빠른 경우)
- **최대 연장량**: SJW Time Quantum
- **조건**: Phase_Seg1 ≥ SJW 이어야 연장 가능
- **효과**: 비트 시간 증가로 타이밍 늦춤

#### Phase_Seg2 단축 (클럭이 느린 경우)
- **최대 단축량**: SJW Time Quantum
- **조건**: Phase_Seg2 ≥ SJW 이어야 단축 가능
- **효과**: 비트 시간 감소로 타이밍 빠름

### SJW 설정 고려사항

#### 클럭 정확도와의 관계
- **높은 정확도 클럭**: 작은 SJW 값으로 충분
- **낮은 정확도 클럭**: 큰 SJW 값 필요
- **일반적 설정**: SJW = 1 Tq (대부분의 경우 충분)

#### 네트워크 안정성
- **너무 작은 SJW**: 클럭 오차 보정 능력 부족
- **너무 큰 SJW**: 불필요한 타이밍 변동으로 시스템 불안정
- **권장 설정**: 필요 최소값 사용

<br>

## 동기화 메커니즘 동작 흐름

### 1. 하드 동기화 (프레임 시작)
```
모든 노드: SOF 감지 → 비트 타이밍 리셋 → 동기화 완료
```

### 2. 재동기화 (프레임 내부)
```
에지 감지 → 타이밍 차이 계산 → SJW 범위 내 조정 → 동기화 유지
```

### 3. 에러 검출 (동기화 실패)
```
SJW 초과 오차 → 동기화 오류 → 에러 플래그 → 프레임 폐기
```

<br>

## 실제 설정 예시

### 예시 1: 표준 High-Speed CAN
- **BaudRate**: 500 kbps
- **CAN 클럭**: 8 MHz
- **설정값**:
  - Total Tq: 16
  - Sync_Seg: 1 Tq
  - Prop_Seg: 2 Tq
  - Phase_Seg1: 11 Tq
  - Phase_Seg2: 2 Tq
  - SJW: 1 Tq

### 예시 2: 장거리 통신용
- **BaudRate**: 125 kbps
- **CAN 클럭**: 8 MHz
- **설정값**:
  - Total Tq: 64
  - Sync_Seg: 1 Tq
  - Prop_Seg: 8 Tq (긴 케이블 고려)
  - Phase_Seg1: 47 Tq
  - Phase_Seg2: 8 Tq
  - SJW: 4 Tq (더 큰 조정 범위)

<br>

## 동기화 관련 오류

### 일반적인 문제들

#### 과도한 클럭 오차
- **원인**: 저품질 크리스털, 극한 온도 조건
- **증상**: 지속적인 재동기화, 높은 오류율
- **해결**: 고정밀 크리스털 사용, 온도 보상

#### 부적절한 SJW 설정
- **원인**: SJW 값이 클럭 오차에 비해 부족
- **증상**: 간헐적 동기화 실패
- **해결**: SJW 값 증가, 클럭 정확도 개선

#### 케이블 지연 미고려
- **원인**: Prop_Seg가 실제 전파 지연보다 작음
- **증상**: 원거리 노드에서 동기화 문제
- **해결**: Prop_Seg 값 증가

### 디버깅 방법

#### 오실로스코프 측정
- **관찰 대상**: 비트 에지의 타이밍 변화
- **분석**: 재동기화 발생 빈도 및 크기
- **판정**: SJW 범위 내 조정 여부 확인

#### CAN 분석기 활용
- **에러 통계**: 동기화 관련 오류 카운트
- **타이밍 분석**: 비트 타이밍의 일관성 검사
- **네트워크 품질**: 전체적인 통신 품질 평가

<br>

## 실무 적용 가이드

### 설계 단계 고려사항
1. **클럭 소스 선택**: 적절한 정확도의 크리스털 선택
2. **비트 타이밍 설계**: 네트워크 특성에 맞는 파라미터 설정
3. **여유도 확보**: 환경 변화를 고려한 충분한 SJW 설정

### 구현 단계 주의사항
1. **파라미터 검증**: 계산된 값의 실제 동작 확인
2. **환경 테스트**: 다양한 온도, 전압 조건에서 검증
3. **호환성 확인**: 다른 제조사 제품과의 상호 운용성

### 유지보수 관점
1. **정기 점검**: 클럭 정확도의 주기적 측정
2. **오류 모니터링**: 동기화 관련 오류 발생 추이 관찰
3. **예방 조치**: 문제 발생 전 예방적 부품 교체

<br>

## 핵심 요약

1. **동기화 필요성**: 브로드캐스트 통신에서 모든 노드의 타이밍 일치 필수
2. **클럭 오차 문제**: 크리스털 오차로 인한 타이밍 누적 차이 발생
3. **Phase_Seg1**: 클럭이 빠른 노드의 타이밍을 늦추기 위한 연장 가능 구간
4. **Phase_Seg2**: 클럭이 느린 노드의 타이밍을 빠르게 하기 위한 단축 가능 구간
5. **SJW**: Phase Segment 조정 시 허용되는 최대 변경량
6. **재동기화**: 프레임 내에서 실시간으로 타이밍 차이를 보정하는 메커니즘
7. **설정 원칙**: 네트워크 특성과 클럭 정확도에 맞는 적절한 값 선택