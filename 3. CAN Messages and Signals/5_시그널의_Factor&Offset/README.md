# Factor와 Offset

## 1. 문제 상황 - 실수형 데이터 전송의 한계

### 기존 방식의 문제점
- **Float 타입**: 실수형 데이터 표현 시 **4바이트** 필요
- **CAN 메시지 제약**: 최대 데이터 영역 **8바이트**
- **결과**: 메시지당 최대 **2개의 실수형 시그널**만 전송 가능

### 버스 로드 관점에서의 문제
- **메시지 개수 증가**: 여러 시그널 전송 시 메시지 분할 필요
- **데이터 크기 증가**: 4바이트씩 사용하는 비효율성
- **버스 로드 상승**: 네트워크 성능 저하 위험

### 해결책의 필요성
```
기존: 12.4V → Float(4바이트) → 32비트 사용
목표: 더 적은 비트로 같은 정보 전달
```

<br>

## 2. Factor와 Offset 기법의 원리

### 기본 개념
- **데이터 변환**: 실수를 정수로 변환하여 전송
- **역변환**: 수신 시 원래 값으로 복원
- **공식 기반**: 수학적 변환을 통한 데이터 압축

### 핵심 공식

#### 송신 측 (데이터 압축)
```
Raw Value = (Value - Offset) / Factor
```

#### 수신 측 (데이터 복원)
```
Value = (Raw Value × Factor) + Offset
```

### 동작 예시 (Factor=0.1, Offset=0)
```
송신 과정:
실제 값: 12.4V
→ Raw Value = (12.4 - 0) / 0.1 = 124
→ 메시지에 124 전송

수신 과정:
받은 값: 124
→ Value = (124 × 0.1) + 0 = 12.4V
→ 원래 값 복원 성공
```

<br>

## 3. Factor와 Offset 기법의 장점

### 데이터 크기 절약
| 방식 | 값 | 필요 비트 수 | 절약 효과 |
|------|----|--------------|-----------| 
| **Float** | 12.4 | 32비트 | - |
| **Factor/Offset** | 124 | 7비트 | **78% 절약** |

### 네트워크 효율성 향상
- **메시지 크기 감소**: 더 많은 시그널을 하나의 메시지에 포함
- **전송 시간 단축**: 작은 데이터로 빠른 전송
- **버스 로드 감소**: 네트워크 자원 효율적 사용

<br>

## 4. Factor와 Offset 기법의 단점

### 정밀도 제한
- **Factor가 최소 단위**: Factor=0.1이면 0.1 단위로만 표현 가능
- **정밀도 손실**: 12.43 → 12.4로 반올림됨
- **Float 대비 제한적**: 소수점 6자리 → 제한된 소수점

### 정밀도 손실 예시
```
송신하려는 값: 12.43V (Factor=0.1)
→ Raw Value = 12.43 / 0.1 = 124.3
→ 정수 변환: 124 (소수점 버림)
→ 수신 값: 124 × 0.1 = 12.4V
→ 결과: 0.03V 손실
```

### 범위 제한
- **Factor에 의존**: 표현 가능한 값의 범위가 Factor에 의해 결정
- **Min/Max 제약**: Float 대비 제한적인 값 범위

<br>

## 5. 정밀도 개선 방법

### Factor 값 조정
```
Factor=0.1 → 정밀도: 0.1 단위
Factor=0.01 → 정밀도: 0.01 단위 (10배 향상)
```

### 정밀도 vs 데이터 크기 트레이드오프
| Factor | 정밀도 | 예시 값 | Raw Value | 필요 비트 |
|--------|--------|---------|-----------|-----------|
| **0.1** | 0.1 단위 | 12.4 | 124 | **7비트** |
| **0.01** | 0.01 단위 | 12.43 | 1243 | **11비트** |

### 최적화 전략
- **요구 정밀도 분석**: 시스템에서 실제 필요한 정밀도 파악
- **데이터 크기 고려**: 버스 로드와 정밀도의 균형점 찾기
- **적절한 Factor 선정**: 최소 필요 정밀도로 Factor 설정

<br>

## 6. 큰 값 범위 처리

### 큰 정수 값의 압축
```
전송 값: 152,000
기존: 18비트 필요
Factor=1000 적용: 152,000/1000 = 152 → 8비트
절약: 10비트 (56% 감소)
```

### 큰 값 처리 시 고려사항
#### 장점
- **상당한 데이터 절약**: 큰 값일수록 압축 효과 증대
- **전송 효율성**: 네트워크 부하 크게 감소

#### 단점 - 정밀도 손실
```
Factor=1000일 때:
152,200 → 152,200/1000 = 152.2 → 152 → 152,000
결과: 200 단위 손실
```

### Factor 조정으로 개선
```
Factor=100일 때:
152,000 → 1,520 (11비트)
정밀도: 100 단위까지 표현 가능
152,200 → 1,522 → 152,200 (정확한 복원)
```

<br>

## 7. 마이너스 값 처리

### Offset 활용한 음수 처리
- **범위 이동**: 음수 범위를 양수로 변환
- **Offset 설정**: 최소값을 0으로 만드는 값

### 음수 처리 예시
```
값 범위: -300,000 ~ +300,000
설정: Factor=1000, Offset=-300,000

전송하려는 값: -152,000
→ Raw Value = (-152,000 - (-300,000)) / 1000
→ Raw Value = 148,000 / 1000 = 148

수신 과정:
받은 값: 148
→ Value = (148 × 1000) + (-300,000)
→ Value = 148,000 - 300,000 = -152,000
```

### 음수 처리의 장점
- **양수 전송**: 복잡한 음수 처리 불필요
- **범위 최적화**: 전체 범위를 효율적으로 활용
- **표준화**: CAN 통신에서 널리 사용되는 방식

<br>

## 8. Factor/Offset 활용 패턴

### 1. 실수형 데이터 압축
```
용도: 소수점 데이터 전송
설정: 작은 Factor (0.1, 0.01), Offset=0
예시: 전압, 온도, 압력 등의 센서 값
```

### 2. 큰 정수 값 압축  
```
용도: 큰 범위의 정수 데이터
설정: 큰 Factor (100, 1000), Offset=0
예시: 거리, 속도, 카운터 값
```

### 3. 음수 범위 처리
```
용도: 양수/음수 모두 포함하는 데이터
설정: 적절한 Factor, 음수 Offset
예시: 가속도, 각속도, 위치 변화량
```

<br>

## 9. CAN DB에서의 Factor/Offset

### DB 저장 정보
```
시그널별 필수 속성:
- Start Bit: 시작 위치
- Length: 데이터 크기  
- Unit: 물리적 단위
- Factor: 변환 계수
- Offset: 오프셋 값
- Comment: 설명 (선택)
```

### 실무 적용 절차
1. **CAN DB 참조**: 시그널의 Factor/Offset 값 확인
2. **송신 시**: Raw Value = (Value - Offset) / Factor
3. **수신 시**: Value = (Raw Value × Factor) + Offset
4. **데이터 검증**: 변환된 값의 유효성 확인

<br>

## 10. 설계 시 고려사항

### Factor 선정 기준
```
고려 요소:
1. 요구 정밀도: 시스템에서 필요한 최소 분해능
2. 값 범위: 전송해야 할 최대/최소 값
3. 데이터 크기: 할당 가능한 비트 수
4. 버스 로드: 네트워크 효율성 목표
```

### 최적화 전략
#### 정밀도 우선
- **높은 정밀도 필요**: 작은 Factor 사용
- **데이터 크기 증가**: 더 많은 비트 필요
- **적용 사례**: 제어 시스템, 안전 관련 데이터

#### 효율성 우선  
- **네트워크 효율 우선**: 큰 Factor 사용
- **정밀도 일부 포기**: 시스템 요구사항 내에서
- **적용 사례**: 상태 정보, 통계 데이터

### 실무 체크리스트
- [ ] **정밀도 요구사항** 분석 완료
- [ ] **값 범위** 정의 완료  
- [ ] **Factor/Offset** 값 계산 및 검증
- [ ] **데이터 크기** 최적화 확인
- [ ] **CAN DB** 정확한 등록
- [ ] **송수신 로직** 구현 및 테스트

<br>

## 11. 핵심 정리

### Factor와 Offset의 핵심 가치
- **데이터 효율성**: 32비트 → 7비트로 대폭 감소 가능
- **네트워크 최적화**: 버스 로드 감소로 성능 향상
- **유연성**: 다양한 데이터 타입과 범위에 적용 가능

### 성공적인 적용을 위한 핵심 원칙
1. **요구사항 기반 설계**: 시스템 요구 정밀도에 맞는 Factor 선정
2. **트레이드오프 고려**: 정밀도와 효율성의 균형점 찾기  
3. **표준화**: 팀 내 Factor/Offset 선정 기준 통일
4. **검증**: 변환 과정에서의 데이터 손실 확인

### 실무 적용 효과
- **메시지 크기 감소**: 평균 50-80% 데이터 절약
- **전송 효율 향상**: 더 많은 시그널을 단일 메시지로 전송
- **버스 로드 최적화**: 네트워크 전체 성능 개선
- **시스템 확장성**: 제한된 대역폭에서 더 많은 기능 구현

Factor와 Offset 기법은 **CAN 통신의 효율성을 극대화하는 핵심 기술**로, 적절한 설계와 구현을 통해 시스템 전체의 성능을 크게 향상시킬 수 있습니다.