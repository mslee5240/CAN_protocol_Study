# 메시지 우선순위 강의

## 1. 브로드캐스트 방식의 근본적 문제

### 동시 전송의 문제점
- CAN 통신은 **브로드캐스트 방식**으로 네트워크 전체에 메시지 전송
- 여러 제어기가 **동시에 메시지를 보내면 충돌 발생**
- 물리적 전선에서 서로 다른 전기적 신호가 만나 **통신 불가**

### CAN의 해결 방식
- 특정 순간에 **오직 하나의 제어기만** 메시지 송신 가능
- 동시 송신 시도 시 **우선순위에 따른 조정(Arbitration)** 수행
- 우선순위가 낮은 제어기는 **대기 후 재시도**

<br>

## 2. 우선순위 결정 규칙

### 핵심 원칙
> **메시지 ID 값이 작을수록 우선순위가 높다**

### 우선순위 적용 단위
- **제어기별이 아닌 메시지별**로 우선순위 결정
- 같은 제어기라도 메시지마다 다른 우선순위 가능
- ID 값에 따라 자동으로 우선순위 결정

### 예시 상황
```
메시지 ID    우선순위    송신 순서
0x123 (123)    높음        1번째 (BMS)
0x134 (134)    중간        2번째 (Engine) 
0x154 (154)    낮음        3번째 (Airbag)
```

<br>

## 3. 우선순위 동작 과정

### 1단계: 동시 송신 시도
- 3개 제어기가 동시에 메시지 송신 시작
- 각각 ID 123, 134, 154 메시지 전송 시도

### 2단계: 첫 번째 중재
- ID 123이 가장 작으므로 **BMS 제어기 우선**
- Engine, Airbag 제어기는 **송신 중단 후 대기**
- BMS 메시지 완전 전송 완료까지 대기

### 3단계: 두 번째 중재  
- BMS 전송 완료 후 Engine, Airbag 재시도
- ID 134 < 154 이므로 **Engine 제어기 우선**
- Airbag 제어기는 다시 대기

### 4단계: 최종 전송
- Engine 전송 완료 후 **Airbag 메시지 전송**
- 더 이상 경쟁자가 없으므로 정상 전송

<br>

## 4. Arbitration Field의 역할

### 필드의 의미
- **Arbitration** = 중재, 조정
- 여러 메시지 간의 **송신 순서를 중재**하는 영역
- 메시지 ID가 위치하는 CAN 메시지의 핵심 부분

### 중재 과정
1. 여러 제어기의 동시 송신 시도 감지
2. ID 값 비교를 통한 우선순위 결정
3. 우선순위에 따른 순차적 메시지 전송
4. 모든 메시지의 순서적 전송 완료

<br>

## 5. 우선순위 동작의 중요한 오해

### ❌ 잘못된 이해
- 우선순위가 높으면 **진행 중인 메시지를 중단**시킬 수 있다
- 언제든지 높은 우선순위 메시지가 **끼어들기** 가능

### ✅ 올바른 이해
- 각 제어기는 **버스 상태를 먼저 확인**
- 다른 메시지 전송 중이면 **완료까지 대기**
- **아무도 전송하지 않을 때만** 송신 시도
- 동시 시도 시에만 우선순위로 중재

### 동작 시나리오
```
상황 1: 정상적인 대기
Engine 메시지 전송 중 → BMS 송신 희망 → BMS 대기 → Engine 완료 후 BMS 전송

상황 2: 동시 송신 시 중재  
버스 유휴 상태 → 다수 제어기 동시 시도 → ID 기반 우선순위 적용 → 순차 전송
```

<br>

## 6. 우선순위 구현 원리

### 도미넌트(Dominant)와 리세시브(Recessive)
- **데이터 0 = 도미넌트** (우성, 강함)
- **데이터 1 = 리세시브** (열성, 약함)
- 동시 출력 시 **도미넌트가 우선**

### 비트별 중재 과정

#### ID 값의 이진수 변환
```
ID 123 (0x7B) = 01111011 (2진수)
ID 134 (0x86) = 10000110 (2진수)  
ID 154 (0x9A) = 10011010 (2진수)
```

#### 비트별 출력 및 중재
| 비트 위치 | BMS(123) | Engine(134) | Airbag(154) | 버스 결과 | 동작 |
|-----------|----------|-------------|-------------|-----------|------|
| 1~4비트   | 동일     | 동일        | 동일        | 동일      | 계속 |
| 5비트     | 0        | 0           | **1**       | 0         | Airbag 중단 |
| 6비트     | 1        | 1           | -           | 1         | 계속 |
| 7비트     | 0        | **1**       | -           | 0         | Engine 중단 |

### 중재 메커니즘
1. **비트별 순차 출력**: ID를 1비트씩 순서대로 전송
2. **출력 후 확인**: 자신이 출력한 값과 버스 값 비교
3. **충돌 감지**: 1을 출력했는데 버스에 0이면 충돌 인식
4. **송신 중단**: 자신보다 우선순위 높은 메시지 존재 시 중단
5. **재시도 대기**: 버스 유휴 상태까지 대기 후 재시도

<br>

## 7. 우선순위의 수학적 원리

### 이진수 비교의 특성
- **왼쪽부터 비교** 시 먼저 1이 나오는 수가 더 큰 값
- ID 154 > ID 134 > ID 123 (크기 순)
- **작은 ID = 높은 우선순위** 구현

### 하드웨어 구현
- CAN 컨트롤러의 **자동 중재 기능**
- 소프트웨어 개발자는 **결과만 이해**하면 충분
- 하드웨어 회로가 **물리적 중재** 자동 수행

<br>

## 8. 실무 적용 사항

### 메시지 ID 설계 시 고려사항
- **중요한 메시지일수록 작은 ID** 할당
- 안전 관련 메시지 (에어백, 브레이크) → 낮은 ID
- 편의 기능 메시지 (오디오, 에어컨) → 높은 ID

### 네트워크 성능 최적화
- **자주 전송되는 메시지**에 높은 우선순위 부여
- **실시간성이 중요한 데이터** 우선 처리
- 전체적인 **버스 로드 균형** 고려

<br>

## 9. 핵심 정리

### 메시지 우선순위의 3가지 핵심 원칙
1. **ID 값이 작을수록 우선순위가 높다**
2. **동시 송신 시에만 중재가 발생한다**  
3. **진행 중인 전송은 중단되지 않는다**

### 실무에서 기억해야 할 사항
- 우선순위는 **자동으로 하드웨어가 처리**
- 개발자는 **적절한 ID 할당**에만 집중
- 중재 과정은 **수 마이크로초** 내에 완료
- **네트워크 효율성** 향상에 크게 기여

### CAN 통신의 장점
- **충돌 없는 안정적 통신** 보장
- **자동 우선순위 처리**로 개발 부담 감소  
- **실시간 통신** 요구사항 만족
- **확장성 있는 네트워크** 구성 가능