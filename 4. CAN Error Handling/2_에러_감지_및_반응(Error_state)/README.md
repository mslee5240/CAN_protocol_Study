# CAN 통신 에러 처리 및 신뢰성 메커니즘

## 1. 노이즈 저항성 (Noise Immunity)

### Differential Signaling
- **구현 방식**: CAN High와 CAN Low 두 선 간의 전압 차이로 데이터 표현
- **노이즈 억제 원리**: 외부 노이즈가 두 라인에 동시에 영향을 주더라도 전압 차이는 유지됨
- **Common Mode Noise 제거**: 동일한 노이즈가 두 선에 동시에 유입되어도 차동 신호는 보존

### 실용적 장점
- 자동차 환경의 전기적 노이즈에 강함
- 긴 케이블 거리에서도 안정적인 통신 가능
- EMI(전자기 간섭) 환경에서 높은 신뢰성 확보

<br>

## 2. 에러 카운터 시스템

### TEC/REC 카운터
- **TEC (Transmit Error Counter)**: 송신 에러 발생 시 증가하는 카운터
- **REC (Receive Error Counter)**: 수신 에러 발생 시 증가하는 카운터
- **동작 방식**: 에러 감지 시 해당 카운터 값이 자동으로 증가

### 에러 상태 관리
- 카운터 값에 따라 노드의 에러 상태가 결정됨
- 성공적인 통신 시 카운터 값은 감소
- 지속적인 에러 발생 시 점진적으로 통신 제한

<br>

## 3. CAN 노드 에러 상태

### Error State 분류
1. **Error Active**: 정상 통신 상태
   - TEC, REC 모두 127 이하
   - 정상적인 송수신 가능

2. **Error Passive**: 제한적 통신 상태
   - TEC 또는 REC가 128 이상
   - 통신 가능하지만 에러 프레임 송신 시 제약

3. **Bus-Off**: 통신 격리 상태
   - TEC가 255를 초과
   - 해당 노드는 버스 통신에서 완전히 격리
   - 복구를 위해서는 소프트웨어적 재초기화 필요

### Bus-Off 복구 메커니즘
- 자동 복구는 불가능
- 애플리케이션에서 명시적으로 재초기화 수행
- 128회 연속 정상 수신 후 Error Active 상태로 복귀

<br>

## 4. 비트 스터핑 (Bit Stuffing)

### 목적
- **동기화 유지**: 수신기의 비트 동기화를 지속적으로 유지
- **에러 감지**: 스터핑 규칙 위반을 통한 추가적인 에러 감지 메커니즘

### 동작 원리
- **규칙**: 연속된 동일 비트가 5개 나오면 반대 비트를 강제 삽입
- **적용 범위**: SOF부터 CRC까지의 구간에 적용
- **자동 처리**: 하드웨어에서 자동으로 수행

### 예시
```
원본 데이터: 11111000
스터핑 후: 110111100000
            ↑   ↑  ↑
         삽입된 0비트들
```

### 에러 감지
- **Stuff Error**: 연속 6비트 동일 값 감지 시 에러로 판단
- **즉시 에러 처리**: 에러 프레임 송신으로 모든 노드에 알림

<br>

## 5. CRC (Cyclic Redundancy Check)

### 기본 원리
- **체크섬 방식**: 송신 데이터로부터 CRC 값을 계산하여 메시지에 포함
- **무결성 검증**: 수신측에서 동일한 방식으로 CRC를 계산하여 비교
- **에러 감지**: 계산된 CRC와 수신된 CRC 불일치 시 에러로 판단

### CAN에서의 CRC
- **CRC-15 사용**: 15비트 CRC로 높은 에러 검출 능력
- **적용 범위**: SOF부터 데이터 필드까지의 모든 비트
- **다항식**: 고정된 생성 다항식 사용

### 에러 검출 능력
- 1비트 에러: 100% 검출
- 2비트 에러: 100% 검출  
- 버스트 에러: 15비트 이하 100% 검출
- 랜덤 에러: 99.997% 검출

<br>

## 6. 통합적 에러 처리 전략

### 다층 보호 메커니즘
1. **물리 계층**: Differential signaling으로 노이즈 방지
2. **프로토콜 계층**: 비트 스터핑으로 동기화 및 에러 감지
3. **데이터 계층**: CRC로 데이터 무결성 검증
4. **시스템 계층**: 에러 카운터로 노드 상태 관리

### 실시간 복구
- **즉시 재전송**: 에러 감지 시 자동 재전송 시도
- **우선순위 유지**: 재전송 시에도 원래 메시지 우선순위 유지
- **네트워크 보호**: Bus-Off를 통한 결함 노드 격리

### 설계 고려사항
- 에러 임계값 설정
- 복구 정책 수립
- 시스템 레벨 에러 모니터링 구현