# CAN FD 소개

## 강의 개요

CAN 통신에는 크게 3가지 종류의 프로토콜이 있으며, 이번 강의에서는 Low Speed CAN과 CAN FD가 High Speed CAN과 어떻게 다른지 설명한다.

## 1. Low Speed CAN

### 주요 특징

**속도**
- 최대 BaudRate: 125kbps
- High Speed CAN보다 속도가 느림

**장점**
- 기본적으로 CAN HIGH와 CAN LOW 두 개의 전선 사용
- 선 하나가 끊어져도 계속 통신 가능

**종단저항 구성**
- High Speed CAN: 버스 양 끝단에 120옴 저항
- Low Speed CAN: 각 제어기마다 저항 두 개씩 설치

**현재 상황**
- 현재 거의 사용되지 않음

<br>

## 2. CAN FD (Fast Data-Rate)

### 개발 배경

**문제점**
- High Speed CAN의 낮은 BaudRate와 작은 데이터 영역
- 제어기 간 데이터 양 증가로 인한 한계

**해결 방향**
- 기존 CAN 통신을 완전히 대체하는 것은 비현실적
- 수십 년간 구축된 개발 환경, 도구, 프로세스를 유지하면서 개선

### CAN FD의 핵심 특징

**기존 CAN과의 호환성**
- CAN FD 메시지와 High Speed CAN 메시지를 같은 네트워크에서 함께 사용 가능
- 하나의 제어기가 메시지별로 다른 타입 적용 가능

### 주요 개선사항

#### 1. 데이터 크기 확장
- High Speed CAN: 최대 8바이트
- CAN FD: 최대 64바이트

#### 2. BaudRate 향상
- 최대 8Mbps로 향상
- 빠른 속도는 데이터 영역에서만 적용

#### 3. 이중 BaudRate 시스템
- **데이터 영역 BaudRate**: 데이터 전송 시 사용
- **Arbitration BaudRate**: 데이터 영역이 아닌 구간에 사용
- 각각 별도의 샘플링 포인트 설정

### 호환성 요구사항

**트랜시버**
- CAN FD와 High Speed CAN을 모두 지원하는 트랜시버 필요
- 예시: TJA1043 트랜시버

**종단저항**
- 기존: 120옴 고정
- CAN FD: 데이터 영역 BaudRate에 따라 크기 변경 가능
- 통신 속도에 따른 임피던스 계산으로 결정

<br>

## 3. DLC (Data Length Code)

### 기본 개념
- Data Length Code의 약자
- CAN 메시지의 데이터 영역 크기를 알려주는 역할
- 총 4비트로 구성 (최대값: 15)

### CAN FD에서의 문제와 해결

**문제점**
- DLC 4비트로는 최대 15까지만 표현 가능
- CAN FD는 최대 64바이트 데이터 전송 가능

**해결 방법**
- DLC 값과 실제 데이터 크기의 매핑 규칙 적용

### CAN FD DLC 매핑 테이블

| DLC 값 | 실제 데이터 크기 (바이트) |
|--------|--------------------------|
| 0-8    | 0-8                      |
| 9      | 12                       |
| 10     | 16                       |
| 11     | 20                       |
| 12     | 24                       |
| 13     | 32                       |
| 14     | 48                       |
| 15     | 64                       |

**규칙**
- DLC 값이 8 이하: DLC 값 = 실제 데이터 길이
- DLC 값이 9 이상: 매핑 테이블에 따른 실제 데이터 길이 적용

<br>

## 4. 실무자 체크포인트

### 개발 시 확인사항

1. **네트워크 타입 확인**
   - 제어기가 참여하는 CAN 네트워크가 CAN FD인지 High Speed CAN인지 확인

2. **메시지별 타입 확인**
   - CAN FD 네트워크에서 각 메시지가 CAN FD 타입인지 High Speed CAN 타입인지 확인

3. **BaudRate 및 Sampling Point 확인**
   - Arbitration 영역과 데이터 영역의 각각 BaudRate 확인
   - 각각의 샘플링 포인트 설정값 확인

4. **CAN DB 활용**
   - 완성차 업체 제공 CAN DB에서 관련 정보 확인
   - DB 정보에 맞게 소프트웨어 구현

<br>

## 5. 추가 참고사항

### 메시지 포맷 차이점
- CAN FD는 High Speed CAN과 메시지 포맷이 거의 비슷하지만 일부 차이 존재
- CRC 필드 계산 방법 및 길이 차이
- 컨트롤 영역 구성의 차이

### 실무 관점
- CAN Controller가 자동으로 처리하는 부분이므로 세부 구현 지식 불필요
- 강의에서 다룬 내용 정도면 CAN FD 업무에 충분

## 결론

CAN FD는 기존 High Speed CAN의 한계를 보완하면서도 호환성을 유지하는 발전된 프로토콜이다. 현재 요구가 증가하는 추세이며, 실무에서는 네트워크 타입, 메시지 타입, BaudRate 설정 등의 기본 사항만 확인하면 효과적으로 활용할 수 있다.